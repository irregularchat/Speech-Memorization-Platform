{% extends 'base.html' %}

{% block title %}Enhanced Practice: {{ text.title }} - Speech Memorization Platform{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced word highlighting styles */
    .practice-text {
        font-size: 1.4rem;
        line-height: 2.2;
        padding: 2rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        margin: 1rem 0;
        font-family: 'Georgia', serif;
        text-align: justify;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Word state styles */
    .word-normal {
        padding: 2px 1px;
        border-radius: 3px;
        transition: all 0.3s ease;
    }
    
    .word-current {
        background: linear-gradient(45deg, #ffc107, #ffeb3b);
        color: #212529;
        font-weight: bold;
        padding: 4px 6px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(255,193,7,0.3);
        animation: pulse-current 2s infinite;
        position: relative;
    }
    
    .word-current::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #ffc107, #ffeb3b);
        border-radius: 7px;
        z-index: -1;
        animation: glow 2s infinite;
    }
    
    .word-completed {
        background-color: #d4edda;
        color: #155724;
        padding: 2px 4px;
        border-radius: 3px;
        opacity: 0.8;
        text-decoration: line-through;
        text-decoration-color: #28a745;
    }
    
    .word-masked {
        background-color: #6c757d;
        color: transparent;
        padding: 2px 4px;
        border-radius: 3px;
        user-select: none;
        cursor: help;
        position: relative;
    }
    
    .word-masked:hover::after {
        content: attr(data-word);
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: #343a40;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 1000;
    }
    
    .word-hint {
        background: linear-gradient(45deg, #17a2b8, #20c997);
        color: white;
        font-weight: bold;
        padding: 4px 6px;
        border-radius: 5px;
        animation: hint-glow 1.5s infinite;
    }
    
    .word-revealed {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        font-weight: bold;
        padding: 4px 6px;
        border-radius: 5px;
        animation: reveal-fade 2s ease-out;
    }
    
    /* Animations */
    @keyframes pulse-current {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    @keyframes glow {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
    }
    
    @keyframes hint-glow {
        0%, 100% { box-shadow: 0 0 5px rgba(23,162,184,0.5); }
        50% { box-shadow: 0 0 15px rgba(23,162,184,0.8); }
    }
    
    @keyframes reveal-fade {
        0% { background: #ffc107; }
        100% { background: linear-gradient(45deg, #28a745, #20c997); }
    }
    
    /* Control panels */
    .adaptive-controls {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }
    
    .hint-panel {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #2196f3;
    }
    
    .timing-indicator {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .timing-progress {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        width: 0%;
        transition: width 0.1s linear;
    }
    
    .speech-status {
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: bold;
    }
    
    .speech-listening {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        animation: listening-pulse 1.5s infinite;
    }
    
    .speech-processing {
        background: linear-gradient(45deg, #ffc107, #ffeb3b);
        color: #212529;
    }
    
    .speech-error {
        background: linear-gradient(45deg, #dc3545, #fd7e14);
        color: white;
    }
    
    @keyframes listening-pulse {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
    }
    
    /* Volume indicator styles */
    .volume-indicator {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        border-radius: 8px;
        padding: 0.75rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .volume-bars {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 2px;
        height: 20px;
        margin-bottom: 0.5rem;
    }
    
    .volume-bar {
        width: 4px;
        background: #28a745;
        border-radius: 2px;
        transition: height 0.1s ease;
        height: 2px;
    }
    
    .volume-bar.active {
        background: #20c997;
    }
    
    /* AI Feedback Panel */
    .ai-feedback-panel {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 10px;
        margin-bottom: 1rem;
        animation: slideDown 0.3s ease-out;
    }
    
    .feedback-header {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #ffc107;
        background: rgba(255, 193, 7, 0.1);
        border-radius: 10px 10px 0 0;
    }
    
    .feedback-content {
        padding: 1rem;
    }
    
    .transcription-display {
        background: #f8f9fa;
        padding: 0.5rem;
        border-radius: 5px;
        border-left: 3px solid #007bff;
        margin: 0.5rem 0;
        font-style: italic;
    }
    
    .confidence-meter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0.5rem 0;
    }
    
    .confidence-bar {
        flex: 1;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .confidence-fill {
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 4px;
    }
    
    .confidence-high { background: #28a745; }
    .confidence-medium { background: #ffc107; }
    .confidence-low { background: #dc3545; }
    
    .pronunciation-tips {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
        padding: 0.75rem;
        border-radius: 5px;
        margin: 0.5rem 0;
    }
    
    .pronunciation-tips ul {
        margin: 0;
        padding-left: 1.5rem;
    }
    
    /* Phrase-based practice styles */
    .phrase-display {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0;
        font-size: 1.2rem;
        line-height: 1.6;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    
    .phrase-display.listening {
        border-color: #007bff;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        animation: pulse 2s infinite;
    }
    
    .phrase-display.processing {
        border-color: #ffc107;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    }
    
    .phrase-display.success {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    }
    
    .phrase-display.error {
        border-color: #dc3545;
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    }
    
    /* Word-level diff highlighting */
    .word-correct {
        background: #d4edda;
        color: #155724;
        padding: 2px 4px;
        border-radius: 3px;
        margin: 0 2px;
        border: 1px solid #c3e6cb;
    }
    
    .word-error {
        background: #f8d7da;
        color: #721c24;
        padding: 2px 4px;
        border-radius: 3px;
        margin: 0 2px;
        border: 1px solid #f5c6cb;
        position: relative;
        cursor: help;
        text-decoration: line-through;
    }
    
    .word-error:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #343a40;
        color: white;
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 5px;
    }
    
    .word-missing {
        background: #fff3cd;
        color: #856404;
        padding: 2px 4px;
        border-radius: 3px;
        margin: 0 2px;
        border: 1px solid #ffeaa7;
        font-style: italic;
    }
    
    .word-extra {
        background: #d1ecf1;
        color: #0c5460;
        padding: 2px 4px;
        border-radius: 3px;
        margin: 0 2px;
        border: 1px solid #bee5eb;
        text-decoration: overline;
    }
    
    /* Speech recognition status */
    .speech-status {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        text-align: center;
        margin: 0.5rem 0;
        transition: all 0.3s ease;
    }
    
    .speech-status.listening {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #90caf9;
    }
    
    .speech-status.processing {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ffcc02;
    }
    
    .speech-status.success {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }
    
    .speech-status.error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
    }
    
    /* Practice mode toggle */
    .practice-mode-selector {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .mode-button {
        background: white;
        border: 2px solid #dee2e6;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        margin: 0 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .mode-button.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .mode-button:hover:not(.active) {
        border-color: #007bff;
        color: #007bff;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }
    
    @keyframes slideDown {
        0% { opacity: 0; transform: translateY(-10px); }
        100% { opacity: 1; transform: translateY(0); }
    }
    
    /* Microphone test modal */
    .mic-test-result {
        text-align: center;
        padding: 1rem;
    }
    
    .quality-indicator {
        font-size: 2rem;
        margin: 1rem 0;
    }
    
    .quality-good { color: #28a745; }
    .quality-fair { color: #ffc107; }
    .quality-poor { color: #dc3545; }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .practice-text {
            font-size: 1.2rem;
            line-height: 2;
            padding: 1rem;
        }
        
        .adaptive-controls {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Practice Area -->
    <div class="col-lg-8">
        <!-- Text Header -->
        <div class="card mb-3">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-brain"></i> {{ text.title }}</h2>
                    <div>
                        <span class="badge bg-{{ text.difficulty }} fs-6">{{ text.get_difficulty_display }}</span>
                        <span class="badge bg-secondary fs-6">{{ total_words }} words</span>
                    </div>
                </div>
                {% if text.description %}
                    <p class="text-muted mb-0">{{ text.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Adaptive Practice Controls -->
        <div class="adaptive-controls">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">
                        <i class="fas fa-eye-slash"></i> Mastery Level: <span id="masteryValue">70%</span>
                    </label>
                    <input type="range" class="form-range" id="masterySlider" min="0" max="100" 
                           value="70" oninput="updateMasteryDisplay()">
                    <small class="text-muted">Hide words you've already mastered</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">
                        <i class="fas fa-clock"></i> Hint Delay: <span id="hintDelayValue">3.0s</span>
                    </label>
                    <input type="range" class="form-range" id="hintDelaySlider" min="1" max="10" 
                           step="0.5" value="3.0" oninput="updateHintDelay()">
                    <small class="text-muted">Time before offering hints</small>
                </div>
            </div>

            <!-- Practice Mode Controls -->
            <div class="text-center mb-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success btn-lg" id="startPracticeBtn" onclick="startAdaptivePractice()">
                        <i class="fas fa-play"></i> Start Practice
                    </button>
                    <button type="button" class="btn btn-warning btn-lg" id="pausePracticeBtn" onclick="pausePractice()" disabled>
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button type="button" class="btn btn-info btn-lg" id="resumePracticeBtn" onclick="resumePractice()" disabled style="display: none;">
                        <i class="fas fa-play"></i> Resume
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg" id="restartPracticeBtn" onclick="restartPractice()">
                        <i class="fas fa-redo"></i> Restart
                    </button>
                </div>
            </div>

            <!-- Speech Status -->
            <div id="speechStatus" class="speech-status" style="display: none;">
                <i class="fas fa-microphone"></i> Ready to listen...
            </div>

            <!-- Volume Indicator -->
            <div id="volumeIndicator" class="volume-indicator" style="display: none;">
                <div class="volume-bars">
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                    <div class="volume-bar"></div>
                </div>
                <small class="text-muted">Speak now...</small>
            </div>

            <!-- AI Feedback Panel -->
            <div id="aiFeedbackPanel" class="ai-feedback-panel" style="display: none;">
                <div class="feedback-header">
                    <strong><i class="fas fa-robot"></i> AI Analysis</strong>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideAIFeedback()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="aiFeedbackContent" class="feedback-content"></div>
            </div>

            <!-- Timing Indicator -->
            <div class="timing-indicator" style="display: none;" id="timingIndicator">
                <div class="timing-progress" id="timingProgress"></div>
            </div>

            <!-- Hint Panel -->
            <div class="hint-panel" id="hintPanel" style="display: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Need help with this word?</strong>
                        <div id="hintMessage" class="small text-muted mt-1"></div>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="requestHint('letter')">
                            <i class="fas fa-font"></i> Letter
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="requestHint('partial')">
                            <i class="fas fa-text-width"></i> Partial
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="requestHint('full')">
                            <i class="fas fa-eye"></i> Full
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="skipWord()">
                            <i class="fas fa-forward"></i> Skip
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Practice Mode Selector -->
        <div class="practice-mode-selector">
            <div class="d-flex justify-content-center align-items-center">
                <span class="me-3"><strong>Practice Mode:</strong></span>
                <button class="mode-button active" id="wordMode" onclick="switchPracticeMode('word')">
                    <i class="fas fa-font"></i> Word-by-Word
                </button>
                <button class="mode-button" id="phraseMode" onclick="switchPracticeMode('phrase')">
                    <i class="fas fa-comments"></i> Natural Phrases
                </button>
            </div>
            <div class="text-center mt-2">
                <small class="text-muted" id="modeDescription">
                    Practice one word at a time for precise memorization
                </small>
            </div>
        </div>

        <!-- Enhanced Text Display -->
        <div class="practice-text" id="practiceText">
            {{ initial_display_text|safe }}
        </div>
        
        <!-- Phrase Display (for phrase-based practice) -->
        <div class="phrase-display d-none" id="phraseDisplay">
            <div id="phraseContent">Click "Start Practice" to begin</div>
        </div>
        
        <!-- Speech Status Display -->
        <div class="speech-status d-none" id="speechStatus">
            Ready to listen...
        </div>

        <!-- Progress Information -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span><i class="fas fa-chart-line"></i> Progress</span>
                    <span id="progressText">0 / {{ total_words }} words</span>
                </div>
                <div class="progress mb-2">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
                <div class="row text-center small">
                    <div class="col-3">
                        <strong id="currentWordDisplay">-</strong><br>
                        <span class="text-muted">Current</span>
                    </div>
                    <div class="col-3">
                        <strong id="attemptsDisplay">0</strong><br>
                        <span class="text-muted">Attempts</span>
                    </div>
                    <div class="col-3">
                        <strong id="hintsUsedDisplay">0</strong><br>
                        <span class="text-muted">Hints</span>
                    </div>
                    <div class="col-3">
                        <strong id="accuracyDisplay">100%</strong><br>
                        <span class="text-muted">Accuracy</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Results -->
        <div id="sessionResults" class="card mt-3" style="display: none;">
            <div class="card-header">
                <h4><i class="fas fa-trophy"></i> Session Complete!</h4>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 id="finalAccuracy" class="text-success">-</h3>
                        <small>Final Accuracy</small>
                    </div>
                    <div class="col-md-3">
                        <h3 id="wordsCompleted">-</h3>
                        <small>Words Completed</small>
                    </div>
                    <div class="col-md-3">
                        <h3 id="totalHints" class="text-info">-</h3>
                        <small>Hints Used</small>
                    </div>
                    <div class="col-md-3">
                        <h3 id="sessionDuration">-</h3>
                        <small>Duration</small>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary" onclick="startAdaptivePractice()">
                        <i class="fas fa-redo"></i> Practice Again
                    </button>
                    <a href="{% url 'text_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Texts
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Current Word Info -->
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="fas fa-crosshairs"></i> Current Focus</h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <h3 id="focusWord" class="text-primary">Ready to start</h3>
                    <p id="focusContext" class="text-muted small">Click "Start Practice" to begin</p>
                </div>
                <div class="row text-center mt-3">
                    <div class="col-6">
                        <strong id="wordPosition">0</strong><br>
                        <small>Position</small>
                    </div>
                    <div class="col-6">
                        <strong id="timeOnWord">0.0s</strong><br>
                        <small>Time on Word</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Word Statistics -->
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Word Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success">{{ word_stats.mastered_words }}</h4>
                        <small>Mastered</small>
                    </div>
                    <div class="col-6">
                        <h4>{{ word_stats.total_words }}</h4>
                        <small>Total</small>
                    </div>
                </div>
                {% if word_stats.tracked_words > 0 %}
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <h4 class="text-info">{{ word_stats.average_mastery|floatformat:1 }}%</h4>
                            <small>Avg Mastery</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">{{ word_stats.words_due_review }}</h4>
                            <small>Need Review</small>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- User Progress -->
        {% if user_progress %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user-chart"></i> Your Progress</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Overall Mastery</span>
                        <span>{{ user_progress.overall_mastery_percentage|floatformat:1 }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: {{ user_progress.overall_mastery_percentage }}%"></div>
                    </div>
                </div>
                
                <div class="row text-center">
                    <div class="col-6">
                        <strong>{{ user_progress.total_sessions }}</strong><br>
                        <small>Sessions</small>
                    </div>
                    <div class="col-6">
                        <strong>{{ user_progress.best_accuracy|floatformat:1 }}%</strong><br>
                        <small>Best Score</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Enhanced Speech Processing Scripts -->
<script src="{% load static %}{% static 'js/device_capability_manager.js' %}"></script>
<script src="{% load static %}{% static 'js/audio_processor.js' %}"></script>
<script src="{% load static %}{% static 'js/streaming_speech_recorder.js' %}"></script>
<script src="{% load static %}{% static 'js/web_speech_recognizer.js' %}"></script>
<script src="{% load static %}{% static 'js/enhanced_speech_manager.js' %}"></script>
<script src="{% load static %}{% static 'js/google_speech_streaming.js' %}"></script>
<script src="{% load static %}{% static 'js/ai_speech_recorder.js' %}"></script>
<script>
// Global state variables
let practiceEngine = {
    sessionKey: null,
    isActive: false,
    isPaused: false,
    currentWord: null,
    currentWordIndex: 0,
    totalWords: {{ total_words }},
    hintsUsed: 0,
    attempts: 0,
    startTime: null,
    wordStartTime: null,
    timingTimer: null,
    hintDelaySeconds: 3.0
};

// Enhanced Speech recognition
let speechManager = null;
let aiSpeechManager = null;
let googleSpeechIntegration = null;
let isListening = false;
let currentPracticeMode = 'word'; // 'word' or 'phrase'
let phraseSessionKey = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    addMicrophoneTestButton();
});

// Practice control functions
function startAdaptivePractice() {
    fetch('{% url "start_adaptive_session" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'text_id': {{ text.id }},
            'session_type': 'adaptive'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            practiceEngine.sessionKey = data.session_key;
            practiceEngine.isActive = true;
            practiceEngine.startTime = new Date();
            practiceEngine.currentWordIndex = data.word_index;
            practiceEngine.currentWord = data.current_word;
            
            updateDisplay(data);
            updateUI('active');
            startWordTiming();
            initializeAISpeech();
        } else {
            showError('Failed to start practice session: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Network error starting practice session');
    });
}

function pausePractice() {
    practiceEngine.isPaused = true;
    stopWordTiming();
    stopSpeechListening();
    updateUI('paused');
}

function resumePractice() {
    practiceEngine.isPaused = false;
    practiceEngine.wordStartTime = new Date();
    startWordTiming();
    startSpeechListening();
    updateUI('active');
}

function restartPractice() {
    if (practiceEngine.sessionKey) {
        completePracticeSession();
    }
    
    // Reset all state
    practiceEngine = {
        sessionKey: null,
        isActive: false,
        isPaused: false,
        currentWord: null,
        currentWordIndex: 0,
        totalWords: {{ total_words }},
        hintsUsed: 0,
        attempts: 0,
        startTime: null,
        wordStartTime: null,
        timingTimer: null,
        hintDelaySeconds: parseFloat(document.getElementById('hintDelaySlider').value)
    };
    
    updateUI('ready');
    document.getElementById('practiceText').innerHTML = `{{ initial_display_text|safe }}`;
    document.getElementById('sessionResults').style.display = 'none';
}

// Word timing and hint system
function startWordTiming() {
    if (practiceEngine.timingTimer) {
        clearInterval(practiceEngine.timingTimer);
    }
    
    practiceEngine.wordStartTime = new Date();
    document.getElementById('timingIndicator').style.display = 'block';
    
    practiceEngine.timingTimer = setInterval(() => {
        if (practiceEngine.isPaused || !practiceEngine.isActive) return;
        
        const elapsed = (new Date() - practiceEngine.wordStartTime) / 1000;
        const progress = Math.min((elapsed / practiceEngine.hintDelaySeconds) * 100, 100);
        
        document.getElementById('timingProgress').style.width = progress + '%';
        document.getElementById('timeOnWord').textContent = elapsed.toFixed(1) + 's';
        
        // Check if hint should be offered
        if (elapsed >= practiceEngine.hintDelaySeconds && !document.getElementById('hintPanel').style.display === 'block') {
            offerHint();
        }
    }, 100);
}

function stopWordTiming() {
    if (practiceEngine.timingTimer) {
        clearInterval(practiceEngine.timingTimer);
        practiceEngine.timingTimer = null;
    }
    document.getElementById('timingIndicator').style.display = 'none';
}

function offerHint() {
    const elapsed = (new Date() - practiceEngine.wordStartTime) / 1000;
    document.getElementById('hintMessage').textContent = 
        `You've been on "${practiceEngine.currentWord}" for ${elapsed.toFixed(1)} seconds.`;
    document.getElementById('hintPanel').style.display = 'block';
}

// Hint request functions
function requestHint(hintType) {
    if (!practiceEngine.sessionKey) return;
    
    fetch('{% url "request_hint" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'session_key': practiceEngine.sessionKey,
            'hint_type': hintType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            practiceEngine.hintsUsed++;
            updateDisplay(data);
            document.getElementById('hintPanel').style.display = 'none';
            document.getElementById('hintsUsedDisplay').textContent = practiceEngine.hintsUsed;
        } else {
            showError('Failed to apply hint: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Network error requesting hint');
    });
}

function skipWord() {
    if (!practiceEngine.sessionKey) return;
    
    fetch('{% url "advance_word" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'session_key': practiceEngine.sessionKey
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_complete) {
                completePracticeSession();
            } else {
                practiceEngine.currentWordIndex = data.word_index;
                practiceEngine.currentWord = data.current_word;
                updateDisplay(data);
                document.getElementById('hintPanel').style.display = 'none';
                startWordTiming();
            }
        } else {
            showError('Failed to skip word: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Network error skipping word');
    });
}

// AI Speech recognition setup and handling
function setupEventListeners() {
    // Listen for speech volume updates
    window.addEventListener('speechVolumeUpdate', (event) => {
        updateVolumeIndicator(event.detail.volume);
    });
    
    // Listen for microphone test completion
    window.addEventListener('microphoneTestComplete', (event) => {
        displayMicrophoneTestResults(event.detail);
    });
}

async function initializeAISpeech() {
    if (!practiceEngine.sessionKey) return;
    
    try {
        // Initialize enhanced speech manager with both Web Speech API and streaming
        speechManager = new EnhancedSpeechManager({
            useWebSpeech: true,
            useStreaming: true,
            preferWebSpeech: true,  // Better for natural speech
            confidenceThreshold: 0.5,
            timeout: 15000,  // 15 seconds for natural speech
            onResult: handleEnhancedSpeechResult,
            onInterimResult: handleInterimSpeechResult,
            onError: handleSpeechError,
            onStart: () => updateSpeechStatus('listening'),
            onStop: () => updateSpeechStatus('idle')
        });
        
        // Keep AI speech manager as fallback
        aiSpeechManager = new AISpeechPracticeManager(practiceEngine.sessionKey, {
            onSpeechProcessed: handleAISpeechResult,
            onError: handleSpeechError,
            onStatusChange: updateSpeechStatus
        });
        
        await aiSpeechManager.initializeRecorder();
        startContinuousListening();
        
        console.log('Enhanced speech recognition initialized');
        console.log('Available methods:', speechManager.getAvailableMethods());
        
    } catch (error) {
        console.error('Failed to initialize speech recognition:', error);
        showError('Speech recognition setup failed: ' + error.message);
    }
}

async function startContinuousListening() {
    if (!practiceEngine.isActive || practiceEngine.isPaused) return;
    
    isListening = true;
    document.getElementById('volumeIndicator').style.display = 'block';
    
    try {
        // Try enhanced speech manager first (Web Speech API + streaming)
        if (speechManager && speechManager.getAvailableMethods().length > 0) {
            console.log('Starting enhanced speech recognition');
            await speechManager.startRecognition();
        } else if (aiSpeechManager) {
            // Fallback to AI speech manager
            console.log('Fallback to AI speech manager');
            await aiSpeechManager.startListening();
            
            // Auto-restart listening after processing (for continuous mode)
            setTimeout(() => {
                if (isListening && practiceEngine.isActive && !practiceEngine.isPaused) {
                    startContinuousListening();
                }
            }, 1000);
        }
        
    } catch (error) {
        console.error('Failed to start listening:', error);
        handleSpeechError('Failed to start speech recognition: ' + error.message);
    }
}

function stopSpeechListening() {
    isListening = false;
    document.getElementById('volumeIndicator').style.display = 'none';
    
    if (speechManager) {
        speechManager.stopRecognition();
    }
    
    if (aiSpeechManager) {
        aiSpeechManager.stopListening();
    }
    
    updateSpeechStatus('ready', 'Ready to listen...');
}

function handleEnhancedSpeechResult(result) {
    console.log('Enhanced speech result:', result);
    
    // Show interim transcription
    if (!result.isFinal) {
        updateSpeechStatus('processing', `Heard: "${result.transcript}"`);
        return;
    }
    
    // Process final transcription
    if (result.transcript && result.transcript.trim().length > 0) {
        processFinalTranscription(result.transcript, result.confidence, result.method);
    } else {
        updateSpeechStatus('listening', 'No speech detected, keep talking...');
        // Restart listening automatically for Web Speech API
        if (result.method === 'webspeech') {
            setTimeout(() => {
                if (isListening && practiceEngine.isActive && !practiceEngine.isPaused) {
                    speechManager.startRecognition();
                }
            }, 500);
        }
    }
}

function handleInterimSpeechResult(result) {
    // Show live transcription feedback
    updateSpeechStatus('listening', `Listening: "${result.transcript}"`);
}

async function processFinalTranscription(transcript, confidence, method) {
    console.log(`Final transcription from ${method}:`, transcript, 'confidence:', confidence);
    
    // Send to backend for word matching and analysis
    try {
        const response = await fetch('{% url "process_word_speech" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                'session_key': practiceEngine.sessionKey,
                'transcription': transcript,
                'confidence': confidence,
                'method': method
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            handleWordMatchResult(result);
        } else {
            console.error('Word processing failed:', result.error);
            updateSpeechStatus('error', 'Processing failed, try again');
            
            // Restart listening
            setTimeout(() => {
                if (isListening && practiceEngine.isActive && !practiceEngine.isPaused) {
                    startContinuousListening();
                }
            }, 1000);
        }
        
    } catch (error) {
        console.error('Error processing transcription:', error);
        updateSpeechStatus('error', 'Network error, try again');
        
        // Restart listening
        setTimeout(() => {
            if (isListening && practiceEngine.isActive && !practiceEngine.isPaused) {
                startContinuousListening();
            }
        }, 1000);
    }
}

function handleWordMatchResult(result) {
    practiceEngine.attempts++;
    document.getElementById('attemptsDisplay').textContent = practiceEngine.attempts;
    
    // Display feedback
    if (result.ai_feedback) {
        displayAIFeedback(result.ai_feedback, result.word_correct);
    }
    
    if (result.word_correct) {
        // Word correctly recognized - advance
        hideAIFeedback();
        
        if (result.is_complete) {
            completePracticeSession();
        } else {
            practiceEngine.currentWordIndex = result.word_index;
            practiceEngine.currentWord = result.current_word;
            updateDisplay(result);
            startWordTiming();
            
            // Continue listening for next word
            setTimeout(() => {
                if (isListening && practiceEngine.isActive && !practiceEngine.isPaused) {
                    startContinuousListening();
                }
            }, 500);
        }
    } else {
        // Keep listening for corrections
        updateSpeechStatus('listening', 'Try again, speak clearly...');
        setTimeout(() => {
            if (isListening && practiceEngine.isActive && !practiceEngine.isPaused) {
                startContinuousListening();
            }
        }, 1500);
    }
}

function handleAISpeechResult(result) {
    practiceEngine.attempts++;
    document.getElementById('attemptsDisplay').textContent = practiceEngine.attempts;
    
    // Display AI feedback
    if (result.ai_analysis) {
        displayAIFeedback(result.ai_analysis, result.success);
    }
    
    if (result.success) {
        // Word correctly recognized - advance
        hideAIFeedback();
        
        if (result.is_complete) {
            completePracticeSession();
        } else {
            practiceEngine.currentWordIndex = result.word_index;
            practiceEngine.currentWord = result.current_word;
            updateDisplay(result);
            document.getElementById('hintPanel').style.display = 'none';
            startWordTiming();
        }
    } else {
        // Word not recognized or incorrect
        if (result.hint_applied) {
            practiceEngine.hintsUsed++;
            document.getElementById('hintsUsedDisplay').textContent = practiceEngine.hintsUsed;
        }
        updateDisplay(result);
        
        // Show detailed feedback for failed attempts
        if (result.ai_analysis && result.ai_analysis.suggestions) {
            setTimeout(() => {
                if (!result.hint_applied) {
                    document.getElementById('hintPanel').style.display = 'block';
                }
            }, 2000);
        }
    }
}

function handleSpeechError(error) {
    console.error('Speech error:', error);
    updateSpeechStatus('error', 'Speech recognition error');
    
    // Try to restart listening after a delay
    setTimeout(() => {
        if (practiceEngine.isActive && !practiceEngine.isPaused) {
            updateSpeechStatus('ready', 'Retrying...');
            startContinuousListening();
        }
    }, 2000);
}

// UI update functions
function updateDisplay(data) {
    if (data.display_text) {
        document.getElementById('practiceText').innerHTML = data.display_text;
    }
    
    if (data.progress !== undefined) {
        const progress = Math.round(data.progress);
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = 
            `${practiceEngine.currentWordIndex} / ${practiceEngine.totalWords} words`;
    }
    
    if (data.current_word) {
        document.getElementById('currentWordDisplay').textContent = data.current_word;
        document.getElementById('focusWord').textContent = data.current_word;
        document.getElementById('wordPosition').textContent = practiceEngine.currentWordIndex + 1;
    }
    
    // Update accuracy
    const accuracy = practiceEngine.attempts > 0 ? 
        ((practiceEngine.currentWordIndex / practiceEngine.attempts) * 100).toFixed(0) : 100;
    document.getElementById('accuracyDisplay').textContent = accuracy + '%';
}

function updateUI(state) {
    const startBtn = document.getElementById('startPracticeBtn');
    const pauseBtn = document.getElementById('pausePracticeBtn');
    const resumeBtn = document.getElementById('resumePracticeBtn');
    const restartBtn = document.getElementById('restartPracticeBtn');
    
    switch(state) {
        case 'ready':
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            document.getElementById('speechStatus').style.display = 'none';
            document.getElementById('hintPanel').style.display = 'none';
            break;
        case 'active':
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            document.getElementById('speechStatus').style.display = 'block';
            break;
        case 'paused':
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'inline-block';
            resumeBtn.disabled = false;
            document.getElementById('speechStatus').style.display = 'none';
            break;
        case 'complete':
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            document.getElementById('speechStatus').style.display = 'none';
            document.getElementById('hintPanel').style.display = 'none';
            document.getElementById('sessionResults').style.display = 'block';
            break;
    }
}

function updateSpeechStatus(status, message) {
    const statusElement = document.getElementById('speechStatus');
    statusElement.className = `speech-status speech-${status}`;
    statusElement.innerHTML = `<i class="fas fa-microphone"></i> ${message}`;
}

function updateMasteryDisplay() {
    const value = document.getElementById('masterySlider').value;
    document.getElementById('masteryValue').textContent = value + '%';
}

function updateHintDelay() {
    const value = document.getElementById('hintDelaySlider').value;
    document.getElementById('hintDelayValue').textContent = value + 's';
    practiceEngine.hintDelaySeconds = parseFloat(value);
}

// Session completion
function completePracticeSession() {
    if (!practiceEngine.sessionKey) return;
    
    fetch('{% url "complete_adaptive_session" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'session_key': practiceEngine.sessionKey
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.statistics) {
            displaySessionResults(data.statistics);
        }
        
        practiceEngine.isActive = false;
        stopWordTiming();
        stopSpeechListening();
        updateUI('complete');
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Network error completing session');
    });
}

function displaySessionResults(stats) {
    document.getElementById('finalAccuracy').textContent = stats.accuracy.toFixed(1) + '%';
    document.getElementById('wordsCompleted').textContent = stats.completed_words;
    document.getElementById('totalHints').textContent = stats.hints_used;
    document.getElementById('sessionDuration').textContent = (stats.duration_seconds / 60).toFixed(1) + 'm';
}

// Utility functions
// AI Feedback and UI functions
function displayAIFeedback(aiAnalysis, isSuccess) {
    const panel = document.getElementById('aiFeedbackPanel');
    const content = document.getElementById('aiFeedbackContent');
    
    let feedbackHTML = '';
    
    // Transcription display
    if (aiAnalysis.transcription) {
        feedbackHTML += `
            <div class="transcription-display">
                <strong>You said:</strong> "${aiAnalysis.transcription}"
            </div>
        `;
    }
    
    // Confidence meter
    if (typeof aiAnalysis.confidence === 'number') {
        const confidencePercent = Math.round(aiAnalysis.confidence * 100);
        const confidenceClass = confidencePercent > 80 ? 'confidence-high' : 
                              confidencePercent > 50 ? 'confidence-medium' : 'confidence-low';
        
        feedbackHTML += `
            <div class="confidence-meter">
                <span>Confidence:</span>
                <div class="confidence-bar">
                    <div class="confidence-fill ${confidenceClass}" style="width: ${confidencePercent}%"></div>
                </div>
                <span>${confidencePercent}%</span>
            </div>
        `;
    }
    
    // Expected vs spoken
    if (aiAnalysis.expected_word && aiAnalysis.transcription) {
        feedbackHTML += `
            <div class="mb-2">
                <strong>Expected:</strong> "${aiAnalysis.expected_word}"<br>
                <strong>Recognition:</strong> ${isSuccess ? '✅ Correct!' : '❌ Not matched'}
            </div>
        `;
    }
    
    // AI feedback message
    if (aiAnalysis.feedback && aiAnalysis.feedback.ai_analysis) {
        feedbackHTML += `
            <div class="alert alert-info">
                <strong>💡 AI Coach:</strong> ${aiAnalysis.feedback.ai_analysis}
            </div>
        `;
    }
    
    // Pronunciation tips
    if (aiAnalysis.suggestions && aiAnalysis.suggestions.length > 0) {
        feedbackHTML += `
            <div class="pronunciation-tips">
                <strong>💭 Suggestions:</strong>
                <ul>
                    ${aiAnalysis.suggestions.map(tip => `<li>${tip}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    // Accuracy breakdown
    if (typeof aiAnalysis.accuracy === 'number') {
        feedbackHTML += `
            <div class="small text-muted">
                Accuracy: ${Math.round(aiAnalysis.accuracy)}% | 
                Error type: ${aiAnalysis.error_type || 'Unknown'}
            </div>
        `;
    }
    
    content.innerHTML = feedbackHTML;
    panel.style.display = 'block';
    
    // Auto-hide after delay if successful
    if (isSuccess) {
        setTimeout(() => hideAIFeedback(), 3000);
    }
}

function hideAIFeedback() {
    document.getElementById('aiFeedbackPanel').style.display = 'none';
}

function updateVolumeIndicator(volume) {
    const volumeBars = document.querySelectorAll('.volume-bar');
    const activeCount = Math.ceil(volume * volumeBars.length);
    
    volumeBars.forEach((bar, index) => {
        if (index < activeCount) {
            bar.classList.add('active');
            bar.style.height = `${Math.min(20, 4 + (index + 1) * 3)}px`;
        } else {
            bar.classList.remove('active');
            bar.style.height = '2px';
        }
    });
}

function addMicrophoneTestButton() {
    // Add microphone test button to controls
    const controlsDiv = document.querySelector('.adaptive-controls .text-center');
    if (controlsDiv) {
        const testButton = document.createElement('button');
        testButton.className = 'btn btn-outline-info btn-sm ms-2';
        testButton.innerHTML = '<i class="fas fa-microphone-alt"></i> Test Mic';
        testButton.onclick = testMicrophone;
        
        controlsDiv.appendChild(testButton);
    }
}

async function testMicrophone() {
    const testRecorder = new AISpeechRecorder({
        maxRecordingTime: 3000, // 3 seconds
        onRecordingStop: (data) => {
            sendMicrophoneTest(data);
        },
        onError: (error) => {
            showError('Microphone test failed: ' + error);
        }
    });
    
    updateSpeechStatus('recording', 'Testing microphone... speak now!');
    
    try {
        await testRecorder.startRecording();
    } catch (error) {
        showError('Failed to start microphone test: ' + error.message);
    }
}

async function sendMicrophoneTest(recordingData) {
    try {
        updateSpeechStatus('processing', 'Analyzing audio quality...');
        
        const response = await fetch('/api/practice/test-microphone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                audio_data: recordingData.base64Data,
                audio_format: recordingData.format
            })
        });
        
        const result = await response.json();
        displayMicrophoneTestResults(result);
        
    } catch (error) {
        showError('Network error during microphone test: ' + error.message);
    } finally {
        updateSpeechStatus('ready', 'Test complete');
    }
}

function displayMicrophoneTestResults(result) {
    if (!result.success) {
        showError('Microphone test failed: ' + result.error);
        return;
    }
    
    const { quality_rating, recommendations, transcription_test } = result;
    
    // Create modal or alert with results
    const qualityIcon = quality_rating === 'good' ? '✅' : 
                       quality_rating === 'fair' ? '⚠️' : '❌';
    
    let message = `${qualityIcon} Microphone Quality: ${quality_rating.toUpperCase()}\n\n`;
    
    if (transcription_test.success) {
        message += `✅ Speech Recognition Test: PASSED\n`;
        message += `📝 Detected: "${transcription_test.text}"\n`;
        message += `🎯 Confidence: ${Math.round(transcription_test.confidence * 100)}%\n\n`;
    } else {
        message += `❌ Speech Recognition Test: FAILED\n\n`;
    }
    
    if (recommendations.length > 0) {
        message += `💡 Recommendations:\n${recommendations.map(r => `• ${r}`).join('\n')}`;
    }
    
    alert(message); // Replace with better modal in production
}

function showError(message) {
    console.error(message);
    // Create better error notification in production
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.style.position = 'fixed';
    errorDiv.style.top = '20px';
    errorDiv.style.right = '20px';
    errorDiv.style.zIndex = '9999';
    errorDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(errorDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (errorDiv.parentElement) {
            errorDiv.remove();
        }
    }, 5000);
}

// =============================================================================
// PHRASE-BASED PRACTICE FUNCTIONS
// =============================================================================

function switchPracticeMode(mode) {
    if (practiceEngine.isActive) {
        showError('Stop current practice session before switching modes');
        return;
    }
    
    currentPracticeMode = mode;
    
    // Update UI
    document.getElementById('wordMode').classList.toggle('active', mode === 'word');
    document.getElementById('phraseMode').classList.toggle('active', mode === 'phrase');
    
    // Update display
    if (mode === 'word') {
        document.getElementById('practiceText').classList.remove('d-none');
        document.getElementById('phraseDisplay').classList.add('d-none');
        document.getElementById('speechStatus').classList.add('d-none');
        document.getElementById('modeDescription').textContent = 'Practice one word at a time for precise memorization';
    } else {
        document.getElementById('practiceText').classList.add('d-none');
        document.getElementById('phraseDisplay').classList.remove('d-none');
        document.getElementById('speechStatus').classList.remove('d-none');
        document.getElementById('modeDescription').textContent = 'Speak naturally in phrases and sentences';
    }
    
    console.log(`Switched to ${mode} practice mode`);
}

function startPhrasePractice() {
    fetch('{% url "start_phrase_practice_session" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'text_id': {{ text.id }},
            'phrase_length': 8  // 8 words per phrase
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            phraseSessionKey = data.session_key;
            practiceEngine.isActive = true;
            practiceEngine.startTime = new Date();
            
            // Display first phrase
            displayPhrase(data.phrase_data);
            updateUI('active');
            initializeAISpeech();
            startPhraseListening();
            
            updateSpeechStatus('ready', 'Ready to listen - speak the phrase naturally');
        } else {
            showError('Failed to start phrase practice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Network error starting phrase practice');
    });
}

function displayPhrase(phraseData) {
    const phraseContent = document.getElementById('phraseContent');
    phraseContent.innerHTML = phraseData.phrase_text;
    
    // Update progress
    document.getElementById('progressBar').style.width = phraseData.progress_percentage + '%';
    document.getElementById('progressText').textContent = 
        `${phraseData.progress_percentage.toFixed(1)}% Complete`;
}

function startPhraseListening() {
    if (!speechManager || !practiceEngine.isActive) return;
    
    updateSpeechStatus('listening', 'Listening... speak naturally');
    document.getElementById('phraseDisplay').className = 'phrase-display listening';
    
    speechManager.startRecognition().then(started => {
        if (!started) {
            updateSpeechStatus('error', 'Failed to start listening');
            document.getElementById('phraseDisplay').className = 'phrase-display error';
        }
    });
}

function processFinalTranscription(transcript, confidence, method) {
    console.log(`Final transcription from ${method}:`, transcript, 'confidence:', confidence);
    
    updateSpeechStatus('processing', 'Processing your speech...');
    document.getElementById('phraseDisplay').className = 'phrase-display processing';
    
    // Send to backend for phrase processing
    fetch('{% url "process_phrase_speech" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'session_key': phraseSessionKey,
            'transcription': transcript,
            'confidence': confidence,
            'method': method
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            handlePhraseResult(data);
        } else {
            console.error('Phrase processing failed:', data.error);
            updateSpeechStatus('error', 'Processing failed, try again');
            document.getElementById('phraseDisplay').className = 'phrase-display error';
            
            // Restart listening
            setTimeout(() => {
                if (practiceEngine.isActive && currentPracticeMode === 'phrase') {
                    startPhraseListening();
                }
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error processing phrase:', error);
        updateSpeechStatus('error', 'Network error, try again');
        document.getElementById('phraseDisplay').className = 'phrase-display error';
        
        // Restart listening
        setTimeout(() => {
            if (practiceEngine.isActive && currentPracticeMode === 'phrase') {
                startPhraseListening();
            }
        }, 2000);
    });
}

function handlePhraseResult(result) {
    console.log('Phrase result:', result);
    
    // Update attempts counter
    practiceEngine.attempts = result.session_info.total_attempts;
    document.getElementById('attemptsDisplay').textContent = practiceEngine.attempts;
    
    if (result.phrase_correct) {
        // Phrase was correct enough or we're allowing progression
        let statusMessage = `Great! Accuracy: ${result.accuracy.toFixed(1)}%`;
        
        if (result.advancement_type === 'partial_progression') {
            statusMessage = `Good progress! Moving forward - ${result.words_added_to_review || 0} words marked for review`;
        } else if (result.advancement_type === 'partial_with_skips') {
            statusMessage = `Good enough! We'll review missed words later`;
        }
        
        updateSpeechStatus('success', statusMessage);
        document.getElementById('phraseDisplay').className = 'phrase-display success';
        
        // Show highlighted feedback with errors marked in red
        if (result.highlighted_html) {
            document.getElementById('phraseContent').innerHTML = result.highlighted_html;
        }
        
        // Show brief feedback about missed words if any
        if (result.missed_words && result.missed_words.length > 0) {
            const missedWordsText = `Missed: ${result.missed_words.join(', ')}`;
            setTimeout(() => {
                updateSpeechStatus('success', `${statusMessage} | ${missedWordsText}`);
            }, 1000);
        }
        
        // Check if practice is complete
        if (result.practice_complete) {
            setTimeout(() => completePhraseSession(result), 3000);
        } else {
            // Move to next phrase
            setTimeout(() => {
                if (result.next_phrase) {
                    displayPhrase(result.next_phrase);
                    updateSpeechStatus('ready', 'Ready for next phrase');
                    document.getElementById('phraseDisplay').className = 'phrase-display';
                    
                    setTimeout(() => {
                        if (practiceEngine.isActive && currentPracticeMode === 'phrase') {
                            startPhraseListening();
                        }
                    }, 1000);
                }
            }, 3000);
        }
    } else {
        // Phrase needs improvement
        let attemptsLeft = result.max_attempts - result.phrase_attempt_count;
        let statusMessage = `Try again - Accuracy: ${result.accuracy.toFixed(1)}%`;
        
        if (attemptsLeft > 0) {
            statusMessage += ` (${attemptsLeft} attempts left)`;
        } else {
            statusMessage = `Keep trying! Focus on the highlighted words`;
        }
        
        updateSpeechStatus('error', statusMessage);
        document.getElementById('phraseDisplay').className = 'phrase-display error';
        
        // Show highlighted feedback with errors
        if (result.highlighted_html) {
            document.getElementById('phraseContent').innerHTML = result.highlighted_html;
        }
        
        // Show AI feedback if available
        if (result.ai_feedback && result.ai_feedback.ai_analysis) {
            displayAIFeedback(result.ai_feedback, false);
        }
        
        // Restart listening after delay
        setTimeout(() => {
            if (practiceEngine.isActive && currentPracticeMode === 'phrase') {
                document.getElementById('phraseDisplay').className = 'phrase-display';
                startPhraseListening();
            }
        }, 3000);
    }
}

function completePhraseSession(result) {
    fetch('{% url "complete_phrase_practice_session" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'session_key': phraseSessionKey
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.session_summary) {
            displayPhraseSessionResults(data.session_summary);
        }
        
        practiceEngine.isActive = false;
        phraseSessionKey = null;
        stopSpeechListening();
        updateUI('complete');
        updateSpeechStatus('success', 'Practice session completed!');
    })
    .catch(error => {
        console.error('Error completing phrase session:', error);
        showError('Error completing session');
    });
}

function displayPhraseSessionResults(summary) {
    let missedWordsSection = '';
    
    if (summary.missed_words_for_review && summary.missed_words_for_review.length > 0) {
        const missedWordsHtml = summary.missed_words_for_review
            .map(item => `<span class="badge bg-warning me-1">${item.word} (${item.missed_count}x)</span>`)
            .join('');
        
        missedWordsSection = `
            <div class="mt-3 p-3 bg-light rounded">
                <h6><i class="fas fa-exclamation-triangle text-warning"></i> Words for Review:</h6>
                <p class="small text-muted mb-2">These words were missed during practice. Consider reviewing them:</p>
                <div>${missedWordsHtml}</div>
            </div>
        `;
    }
    
    const resultsHtml = `
        <div class="alert alert-success">
            <h4><i class="fas fa-check-circle"></i> Phrase Practice Complete!</h4>
            <div class="row mt-3">
                <div class="col-md-3 text-center">
                    <h5>${summary.phrases_completed}</h5>
                    <small>Phrases Completed</small>
                </div>
                <div class="col-md-3 text-center">
                    <h5>${summary.total_attempts}</h5>
                    <small>Total Attempts</small>
                </div>
                <div class="col-md-3 text-center">
                    <h5>${summary.completion_rate.toFixed(1)}%</h5>
                    <small>Completion Rate</small>
                </div>
                <div class="col-md-3 text-center">
                    <h5>${(summary.session_duration / 60).toFixed(1)}m</h5>
                    <small>Duration</small>
                </div>
            </div>
            <div class="mt-3">
                <p><strong>Words Covered:</strong> ${summary.total_words_covered} / ${summary.total_words}</p>
                <p class="text-muted">Great job practicing with natural speech patterns!</p>
            </div>
            ${missedWordsSection}
        </div>
    `;
    
    document.getElementById('sessionResults').innerHTML = resultsHtml;
    document.getElementById('sessionResults').style.display = 'block';
}

function updateSpeechStatus(status, message) {
    const statusEl = document.getElementById('speechStatus');
    statusEl.className = `speech-status ${status}`;
    statusEl.textContent = message;
    
    console.log(`Speech status: ${status} - ${message}`);
}

// Override the existing start practice function to handle both modes
const originalStartAdaptivePractice = startAdaptivePractice;
startAdaptivePractice = function() {
    if (currentPracticeMode === 'phrase') {
        startPhrasePractice();
    } else {
        originalStartAdaptivePractice();
    }
};

// Override processFinalTranscription function for phrase mode
const originalProcessFinalTranscription = window.processFinalTranscription || function() {};
window.processFinalTranscription = function(transcript, confidence, method) {
    if (currentPracticeMode === 'phrase' && phraseSessionKey) {
        processFinalTranscription(transcript, confidence, method);
    } else {
        originalProcessFinalTranscription(transcript, confidence, method);
    }
};
</script>
{% endblock %}